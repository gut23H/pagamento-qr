<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Dona Paula ‚Ä¢ Caixa PIX</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

<style>
body{font-family:Arial;background:#fff3ee;padding:15px}
h1{text-align:center;color:#b63b2e}
.card{background:#fff;padding:15px;border-radius:14px;margin-bottom:15px;box-shadow:0 5px 15px rgba(0,0,0,.1)}
input,button{width:100%;padding:10px;margin-top:8px;border-radius:8px;border:1px solid #ccc}
button{background:#b63b2e;color:#fff;border:none;font-weight:bold;cursor:pointer}
button.green{background:#2e7d32}
button.red{background:#c62828}
button.blue{background:#1565c0}
#qrcode{text-align:center;margin:10px}
.list{max-height:300px;overflow:auto}
.item{border-bottom:1px solid #eee;padding:8px}
.status-pago{color:green;font-weight:bold}
.status-pendente{color:#c62828}
.confirmacao{display:none;text-align:center;font-size:22px;color:green;animation:zoom .5s}
@keyframes zoom{from{transform:scale(.5);opacity:0}to{transform:scale(1);opacity:1}}
.stats{display:flex;gap:10px}
.stats div{flex:1;background:#ffe0d6;padding:10px;border-radius:10px;text-align:center}
</style>
</head>

<body>

<h1>üç¨ Dona Paula ‚Ä¢ Caixa PIX</h1>

<div class="card" id="gerador">
  <input id="cliente" placeholder="Nome do cliente">
  <input id="valor" type="number" step="0.01" placeholder="Valor">
  <input id="data" type="date">
  <button onclick="gerar()">Gerar QR Code</button>

  <div id="qrcode"></div>

  <input id="codigoPix" readonly>
  <button class="blue" onclick="copiar()">üìã Copiar c√≥digo PIX</button>
  <button class="green" onclick="pagar()">‚úÖ J√° pagou</button>
</div>

<div class="confirmacao" id="ok">üíñ Pagamento confirmado!</div>

<div class="card">
  <h3>üìä Resumo</h3>
  <div class="stats">
    <div><b id="totalQR">0</b><br>QR gerados</div>
    <div><b id="totalPago">0</b><br>Pagos</div>
    <div><b id="faturamento">R$ 0,00</b></div>
  </div>
</div>

<div class="card">
  <h3>üîç Pesquisar por data</h3>
  <input id="filtroData" type="date" onchange="filtrar()">
  <div class="list" id="lista"></div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getFirestore, collection, addDoc, updateDoc, deleteDoc, doc, onSnapshot, query, where, getDocs }
from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyDDykQQH_vhq9lj4dlwPZgtrZQDFr8eVcI",
  authDomain: "dona-paula-pix.firebaseapp.com",
  projectId: "dona-paula-pix"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

const PIX_CHAVE="gustavopaulo2283@gmail.com";
const PIX_NOME="DONA PAULA";
const PIX_CIDADE="BRASIL";

let idAtual="", codigoAtual="";

window.gerar = async ()=>{
  const cliente=clienteInput();
  const valor=valorInput();
  const data=dataInput();
  if(!cliente||!valor||!data) return alert("Preencha tudo");

  qrcode.innerHTML="";
  ok.style.display="none";
  gerador.style.display="block";

  codigoAtual = gerarPix(valor);
  codigoPix.value = codigoAtual;

  new QRCode(qrcode,{text:codigoAtual,width:220,height:220});

  const ref = await addDoc(collection(db,"pagamentos"),{
    cliente,valor:Number(valor),data,status:"pendente"
  });
  idAtual=ref.id;
};

window.pagar = async ()=>{
  if(!idAtual) return;
  await updateDoc(doc(db,"pagamentos",idAtual),{status:"pago"});
  gerador.style.display="none";
  ok.style.display="block";
};

window.copiar=()=>navigator.clipboard.writeText(codigoAtual);

onSnapshot(collection(db,"pagamentos"),snap=>{
  let t=0,p=0,s=0;
  lista.innerHTML="";
  snap.forEach(d=>{
    const x=d.data(); t++;
    if(x.status==="pago"){p++;s+=x.valor}
    lista.innerHTML+=`
      <div class="item">
        <b>${x.cliente}</b> ‚Ä¢ R$ ${x.valor.toFixed(2)} ‚Ä¢ ${x.data}
        <span class="status-${x.status}">${x.status}</span>
        <button class="red" onclick="excluir('${d.id}')">Excluir</button>
      </div>`;
  });
  totalQR.innerText=t; totalPago.innerText=p; faturamento.innerText="R$ "+s.toFixed(2);
});

window.excluir=async id=>await deleteDoc(doc(db,"pagamentos",id));

window.filtrar=async ()=>{
  const d=filtroData.value; if(!d) return;
  const q=query(collection(db,"pagamentos"),where("data","==",d));
  const snap=await getDocs(q);
  lista.innerHTML="";
  snap.forEach(x=>{
    const v=x.data();
    lista.innerHTML+=`<div class="item">${v.cliente} ‚Ä¢ R$ ${v.valor.toFixed(2)} ‚Ä¢ ${v.status}</div>`;
  });
};

const clienteInput=()=>document.getElementById("cliente").value;
const valorInput=()=>document.getElementById("valor").value;
const dataInput=()=>document.getElementById("data").value;

function emv(i,v){return i+v.length.toString().padStart(2,"0")+v}
function crc(p){let c=0xFFFF;for(let i=0;i<p.length;i++){c^=p.charCodeAt(i)<<8;for(let j=0;j<8;j++)c=(c&0x8000)?(c<<1)^0x1021:c<<1}return(c&0xFFFF).toString(16).toUpperCase().padStart(4,"0")}
function gerarPix(valor){
  let p=emv("00","01")+emv("26",emv("00","BR.GOV.BCB.PIX")+emv("01",PIX_CHAVE))+
  emv("52","0000")+emv("53","986")+emv("54",Number(valor).toFixed(2))+
  emv("58","BR")+emv("59",PIX_NOME)+emv("60",PIX_CIDADE)+"6304";
  return p+crc(p);
}
</script>

</body>
</html>
