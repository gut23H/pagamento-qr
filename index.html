<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Dona Paula ‚Ä¢ Caixa PIX</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

<style>
* { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Segoe UI', Arial, sans-serif; }
body { background: linear-gradient(135deg,#ffe6dc,#fff); padding: 20px; }
header { text-align: center; margin-bottom: 30px; }
header h1 { color: #b63b2e; font-size: 32px; }
.cards-container { display: flex; gap: 20px; justify-content: space-between; flex-wrap: wrap; }
.card { background: #fff; padding: 20px; border-radius: 20px; box-shadow: 0 10px 25px rgba(0,0,0,.12); flex: 1 1 30%; min-width: 250px; }
input, button { width: 100%; padding: 12px; margin-top: 10px; border-radius: 12px; border: 1px solid #ddd; font-size: 15px; }
input:focus { outline: none; border-color: #b63b2e; box-shadow: 0 0 6px rgba(182,59,46,.4); }
button { background: #b63b2e; color: #fff; border: none; font-weight: 600; cursor: pointer; transition: .3s; }
button:hover { transform: scale(1.03); }
.green { background: #2e7d32; }
.red { background: #c62828; }
.blue { background: #1565c0; }
#qrcode { display: flex; justify-content: center; margin: 15px 0; }
#qrcode canvas { animation: pulse 1.2s infinite ease-in-out; }
@keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.08); } 100% { transform: scale(1); } }
.stats { display: flex; gap: 10px; }
.stats div { flex: 1; background: #ffe0d6; padding: 15px; border-radius: 14px; text-align: center; font-weight: 600; }
.list { max-height: 260px; overflow: auto; }
.item { padding: 10px; border-bottom: 1px solid #eee; }
.status-pago { color: #2e7d32; font-weight: bold; }
.status-pendente { color: #c62828; font-weight: bold; }
.confirmacao { display: none; text-align: center; font-size: 26px; color: #2e7d32; padding: 40px; }
.confirmacao .check { font-size: 60px; }
@media(max-width: 900px){ .cards-container { flex-direction: column; } }
</style>
</head>

<body>

<header>
  <h1>üç¨ Dona Paula ‚Ä¢ Caixa PIX</h1>
</header>

<div class="cards-container">
  <!-- PAGAMENTO -->
  <div class="card" id="gerador">
    <h3>üí≥ Pagamento</h3>
    <input id="cliente" placeholder="Nome do cliente">
    <input id="produto" placeholder="Produto">
    <input id="valor" type="number" step="0.01" placeholder="Valor">
    <input id="data" type="date">
    <button onclick="gerar()">Gerar QR Code</button>
    <div id="qrcode"></div>
    <input id="codigoPix" readonly>
    <button class="blue" onclick="copiar()">üìã Copiar PIX</button>
    <button class="green" onclick="pagar()">‚úÖ J√° pagou</button>
  </div>

  <!-- RESUMO -->
  <div class="card">
    <h3>üìä Resumo</h3>
    <div class="stats">
      <div><span id="totalQR">0</span><br>QR gerados</div>
      <div><span id="totalPago">0</span><br>Pagos</div>
      <div><span id="faturamento">R$ 0,00</span><br>Faturamento</div>
    </div>
  </div>

  <!-- BUSCAR -->
  <div class="card">
    <h3>üîç Buscar Cliente</h3>
    <input id="filtroNome" placeholder="Nome do cliente">
    <input id="filtroData" type="date">
    <button class="blue" onclick="filtrar()">Buscar</button>
    <div class="list" id="lista"></div>
  </div>
</div>

<div class="confirmacao" id="ok">
  <div class="check">üíñ</div>
  Status atualizado com sucesso!
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getFirestore, collection, addDoc, updateDoc, deleteDoc, doc, onSnapshot, getDocs, query, where, getDocsFromCache } 
from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const firebaseConfig = {
   apiKey: "AIzaSyDDykQQH_vhq9lj4dlwPZgtrZQDFr8eVcI",
  authDomain: "dona-paula-pix.firebaseapp.com",
  projectId: "dona-paula-pix"
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

const PIX_CHAVE="gustavopaulo2283@gmail.com";
const PIX_NOME="DONA PAULA";
const PIX_CIDADE="BRASIL";

let codigoAtual="";

// ===== GERAR PIX =====
window.gerar = async ()=>{
  const cliente = document.getElementById("cliente").value;
  const produto = document.getElementById("produto").value;
  const valor = document.getElementById("valor").value;
  const data = document.getElementById("data").value;
  if(!cliente||!produto||!valor||!data) return alert("‚ö†Ô∏è Preencha todos os campos");

  document.getElementById("qrcode").innerHTML="";
  document.getElementById("ok").style.display="none";

  codigoAtual = gerarPix(valor);
  document.getElementById("codigoPix").value = codigoAtual;

  new QRCode(document.getElementById("qrcode"), {text:codigoAtual,width:220,height:220});

  await addDoc(collection(db,"pagamentos"),{
    cliente, produto, valor:Number(valor), data, status:"pendente"
  });
};

// ===== J√Å PAGO (SALVA SE NAO EXISTIR) =====
window.pagar = async ()=>{
  const cliente = document.getElementById("cliente").value;
  const produto = document.getElementById("produto").value;
  const valor = Number(document.getElementById("valor").value);
  const data = document.getElementById("data").value;

  if(!cliente||!produto||!valor||!data) return alert("‚ö†Ô∏è Preencha todos os campos");

  // Verifica se j√° existe um pagamento com mesmo cliente/produto/data
  const q = query(collection(db,"pagamentos"), 
                  where("cliente","==",cliente), 
                  where("produto","==",produto), 
                  where("data","==",data));
  const snap = await getDocs(q);

  if(snap.empty){
    // Cria novo registro se n√£o existir
    await addDoc(collection(db,"pagamentos"),{
      cliente, produto, valor, data, status:"pago"
    });
  } else {
    // Atualiza status do primeiro encontrado
    const id = snap.docs[0].id;
    await updateDoc(doc(db,"pagamentos",id),{status:"pago"});
  }

  document.getElementById("ok").style.display="block";
  setTimeout(()=>document.getElementById("ok").style.display="none",2000);

  // Limpa campos
  document.getElementById("cliente").value="";
  document.getElementById("produto").value="";
  document.getElementById("valor").value="";
  document.getElementById("data").value="";
  document.getElementById("qrcode").innerHTML="";
  document.getElementById("codigoPix").value="";
  codigoAtual="";
};

// ===== COPIAR PIX =====
window.copiar = async () => {
  if(!codigoAtual) return alert("‚ö†Ô∏è Gere o QR Code primeiro");
  await navigator.clipboard.writeText(codigoAtual);
  alert("‚úÖ C√≥digo PIX copiado!");
};

// ===== LISTA =====
onSnapshot(collection(db,"pagamentos"), snap => atualizarLista(snap.docs));
window.excluir = async id => await deleteDoc(doc(db,"pagamentos",id));

// ===== FILTRO =====
window.filtrar = async () => {
  const nome = document.getElementById("filtroNome").value.toLowerCase();
  const data = document.getElementById("filtroData").value;

  const snap = await getDocs(collection(db,"pagamentos"));

  const filtrados = snap.docs.filter(d=>{
    const x = d.data();
    let cond = true;
    if(nome) cond = cond && x.cliente.toLowerCase().includes(nome);
    if(data) cond = cond && x.data === data;
    return cond;
  });

  atualizarLista(filtrados);
};

// ===== ATUALIZA LISTA E RESUMO =====
function atualizarLista(docs){
  let t=0, p=0, s=0;
  const lista = document.getElementById("lista");
  lista.innerHTML="";
  docs.forEach(d=>{
    const x = d.data ? d.data() : d.data;
    t++;
    if(x.status==="pago"){p++;s+=x.valor;}
    lista.innerHTML += `
      <div class="item">
        <b>${x.cliente}</b><br>
        üõí ${x.produto}<br>
        üí∞ R$ ${x.valor.toFixed(2)} ‚Ä¢ ${x.data}<br>
        <span class="status-${x.status}">${x.status}</span>
        <button class="red" onclick="excluir('${d.id}')">Excluir</button>
      </div>`;
  });
  document.getElementById("totalQR").innerText = t;
  document.getElementById("totalPago").innerText = p;
  document.getElementById("faturamento").innerText = "R$ "+s.toFixed(2);
}

// ===== FUN√á√ïES PIX =====
function emv(i,v){return i+v.length.toString().padStart(2,'0')+v}
function crc16(payload){
  let crc=0xFFFF;
  for(let i=0;i<payload.length;i++){
    crc ^= payload.charCodeAt(i)<<8;
    for(let j=0;j<8;j++){ crc = (crc & 0x8000)? (crc<<1)^0x1021 : crc<<1; }
  }
  return (crc&0xFFFF).toString(16).toUpperCase().padStart(4,'0');
}
function gerarPix(valor){
  let payload="";
  payload += emv("00","01"); 
  payload += emv("26", emv("00","BR.GOV.BCB.PIX")+emv("01",PIX_CHAVE));
  payload += emv("52","0000"); 
  payload += emv("53","986"); 
  payload += emv("54",Number(valor).toFixed(2)); 
  payload += emv("58","BR"); 
  payload += emv("59",PIX_NOME); 
  payload += emv("60",PIX_CIDADE); 
  payload += "6304"; 
  return payload + crc16(payload);
}
</script>

<script src="seguranca.js"></script>
<script src="seguranca-obfuscado.js"></script>
</body>
</html>
